name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio
          ~/.cache/pip
        key: ${{ runner.os }}-pio-${{ hashFiles('**/build_precompiled_libs.py') }}
        restore-keys: |
          ${{ runner.os }}-pio-
    
    - name: Initialize and verify submodule
      run: |
        echo "=== Checking submodule status ==="
        git submodule status
        
        echo ""
        echo "=== Updating submodules ==="
        git submodule update --init --recursive
        
        echo ""
        echo "=== Verifying submodule content ==="
        if [ -d "platform-espressif32-54.03.20-esp" ]; then
          echo "âœ… Submodule directory exists"
          echo "Files in submodule:"
          ls -la platform-espressif32-54.03.20-esp/ | head -20
          
          echo ""
          echo "Checking for builder directory:"
          if [ -d "platform-espressif32-54.03.20-esp/builder" ]; then
            echo "âœ… builder directory exists"
          else
            echo "âŒ ERROR: builder directory not found!"
            exit 1
          fi
        else
          echo "âŒ ERROR: Submodule not found!"
          exit 1
        fi
    
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
    
    - name: Build pre-compiled libraries
      run: |
        python3 build_precompiled_libs.py
        
        echo ""
        echo "=== Generated platformio.ini ==="
        cat build_temp/platformio.ini
        
        echo ""
        echo "=== Generated main.cpp ==="
        head -20 build_temp/src/main.cpp
    
    - name: Debug - Check build artifacts
      run: |
        echo "=== Checking build artifacts ==="
        echo "main.cpp.o files found:"
        find build_temp/.pio/build -name "main.cpp.o" -type f
        
        echo ""
        echo "=== FrameworkArduino/main.cpp.o symbols ==="
        MAIN_O=$(find build_temp/.pio/build -path "*/FrameworkArduino/main.cpp.o" | head -1)
        if [ -n "$MAIN_O" ]; then
          TOOLCHAIN=$(find ~/.platformio/packages -name "xtensa-esp32-elf-nm" -type f 2>/dev/null | head -1)
          if [ -n "$TOOLCHAIN" ]; then
            NM_CMD=$(dirname "$TOOLCHAIN")/xtensa-esp32-elf-nm
            echo "Checking symbols in $MAIN_O:"
            $NM_CMD "$MAIN_O" | grep -E "app_main|loopTask" || echo "No app_main found!"
          fi
        else
          echo "ERROR: FrameworkArduino/main.cpp.o not found!"
        fi
    
    - name: Verify prebuilt directory
      run: |
        ls -lah prebuilt/
        echo "Library size:"
        du -h prebuilt/liburack_arduino.a
        echo "Headers count:"
        find prebuilt/include -name "*.h" | wc -l
        
        # Find toolchain path
        TOOLCHAIN=$(find ~/.platformio/packages -name "xtensa-esp32-elf-nm" -type f 2>/dev/null | head -1)
        if [ -n "$TOOLCHAIN" ]; then
          echo "Toolchain found: $TOOLCHAIN"
          NM_CMD=$(dirname "$TOOLCHAIN")/xtensa-esp32-elf-nm
          AR_CMD=$(dirname "$TOOLCHAIN")/xtensa-esp32-elf-ar
          
          echo "Object files in library:"
          $AR_CMD t prebuilt/liburack_arduino.a | wc -l
          
          echo "Checking for app_main symbol:"
          if $NM_CMD prebuilt/liburack_arduino.a | grep -q "T app_main"; then
            echo "âœ… app_main found in library"
          else
            echo "âŒ ERROR: app_main NOT found in library!"
            echo "Library contents:"
            $AR_CMD t prebuilt/liburack_arduino.a | grep main || echo "No main files found"
            exit 1
          fi
        else
          echo "âš ï¸ Warning: Toolchain not found, skipping symbol verification"
        fi
    
    - name: Create release archive
      run: |
        # Get version from tag
        VERSION=${GITHUB_REF#refs/tags/}
        
        # Create archive with all necessary files
        zip -r platform-urack-esp32-${VERSION}.zip \
          platform.json \
          platform.py \
          boards/ \
          builder/ \
          prebuilt/ \
          build_precompiled_libs.py \
          README.md \
          .gitignore
        
        echo "Archive created: platform-urack-esp32-${VERSION}.zip"
        ls -lh platform-urack-esp32-${VERSION}.zip
    
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        
        cat > release_notes.md << EOF
        # URack ESP32 Platform ${VERSION}
        
        ## Features
        - Custom PlatformIO platform for ESP32
        - Pre-compiled Arduino framework and libraries
        - Support for mod-esp32-v1 board
        - ~10x faster build times
        
        ## Usage
        
        Add to your \`platformio.ini\`:
        
        \`\`\`ini
        [env:modesp32v1]
        platform = https://github.com/${{ github.repository }}/releases/download/${VERSION}/platform-urack-esp32-${VERSION}.zip
        board = mod-esp32-v1
        framework = arduino
        monitor_speed = 115200
        \`\`\`
        
        ## What's Included
        
        - âœ… Pre-compiled Arduino Core for ESP32
        - âœ… Pre-compiled libraries: Adafruit GFX, SSD1306, ESP32Encoder, NeoPixel, MIDI, BusIO
        - âœ… All necessary headers (~4100 files)
        - âœ… ESP-IDF integration
        - âœ… Bootloader and partition tables
        
        ## Build Stats
        
        - Library size: $(du -h prebuilt/liburack_arduino.a | cut -f1)
        - Headers: $(find prebuilt/include -name "*.h" | wc -l) files
        - Object files: $(xtensa-esp32-elf-ar t prebuilt/liburack_arduino.a | wc -l)
        
        ## Requirements
        
        - PlatformIO Core >= 6.1.16
        - ESP32 toolchain (auto-installed)
        EOF
        
        cat release_notes.md
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        body_path: release_notes.md
        files: |
          platform-urack-esp32-${{ github.ref_name }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Release summary
      run: |
        echo "âœ… Release ${{ github.ref_name }} created successfully!"
        echo "ðŸ“¦ Archive: platform-urack-esp32-${{ github.ref_name }}.zip"
        echo "ðŸ”— URL: https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/platform-urack-esp32-${{ github.ref_name }}.zip"

